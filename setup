#!/bin/bash

# Color definitions
RED=`tput setaf 1`
GREEN=`tput setaf 2`
YELLOW=`tput setaf 3`
BLUE=`tput setaf 4`
RST=`tput sgr0`

# Trap Ctrl-C to exit the entire script
trap 'echo -e "\n${RED}Setup interrupted by user. Exiting...${RST}"; exit 1' INT

# Logging functions
log_info() {
    echo -e "${BLUE}[INFO]${RST} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${RST} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${RST} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${RST} $1"
}

# Function to setup for detected distribution
setup_distribution() {
    local dist=$1
    log_success "$PRETTY_NAME detected"
    log_info "Setting up environment for $dist..."

    export DIST_ROOT=./dist/$dist

    if [ -f "$DIST_ROOT/setup.sh" ]; then
        log_info "Executing $dist setup script..."
        source $DIST_ROOT/setup.sh
        if [ $? -eq 0 ]; then
            log_success "$dist setup completed successfully"
        else
            log_error "$dist setup failed"
            return 1
        fi
    else
        log_error "Setup script not found for $dist: $DIST_ROOT/setup.sh"
        return 1
    fi
}

# Function to handle unrecognized distribution
handle_unrecognized_distro() {
    log_error "Unrecognized Distribution: $DIST"
    log_info "Supported distributions: Fedora, Ubuntu"
    log_info "Please ensure you're using a supported Linux distribution"
}

# Main setup function
main() {
    echo -e "${GREEN}Linux Environment Setup Script${RST}"
    echo -e "${GREEN}================================${RST}"

    # Collect forwarding args (only forward recognized flags like --neovim)
    local FORWARD_ARGS=()
    for _a in "$@"; do
        case "$_a" in
            --neovim)
                FORWARD_ARGS+=("$_a")
                ;;
        esac
    done

    local RELEASE_FILE=/etc/os-release
    local DIST=""
    local PRETTY_NAME=""

    if [ -f "$RELEASE_FILE" ]; then
        DIST=$(grep '^NAME=' $RELEASE_FILE | sed -n 's/NAME=//p' | tr -d '"')
        PRETTY_NAME=$(grep '^PRETTY_NAME=' $RELEASE_FILE | sed -n 's/PRETTY_NAME=//p' | tr -d '"')
    else
        log_error "Cannot find /etc/os-release file"
        log_error "This script requires a Linux distribution with systemd"
        exit 1
    fi

    case "$DIST" in
        *Fedora*)
            # Execute the distro setup script and forward recognized args
            export DIST_ROOT=./dist/Fedora
            if [ -f "$DIST_ROOT/setup.sh" ]; then
                log_info "Executing Fedora setup script..."
                if bash "$DIST_ROOT/setup.sh" "${FORWARD_ARGS[@]}"; then
                    log_success "Fedora setup completed successfully"
                else
                    log_error "Fedora setup failed"
                    exit 1
                fi
            else
                log_error "Setup script not found for Fedora: $DIST_ROOT/setup.sh"
                exit 1
            fi
            ;;
        *Ubuntu*)
            export DIST_ROOT=./dist/Ubuntu
            if [ -f "$DIST_ROOT/setup.sh" ]; then
                log_info "Executing Ubuntu setup script..."
                if bash "$DIST_ROOT/setup.sh" "${FORWARD_ARGS[@]}"; then
                    log_success "Ubuntu setup completed successfully"
                else
                    log_error "Ubuntu setup failed"
                    exit 1
                fi
            else
                log_error "Setup script not found for Ubuntu: $DIST_ROOT/setup.sh"
                exit 1
            fi
            ;;
        *)
            handle_unrecognized_distro
            exit 1
            ;;
    esac

    echo -e "${GREEN}\nSetup completed successfully!${RST}"
}

main
